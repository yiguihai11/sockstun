name: "Build"

on:
  push:
    branches:
      - main
      - feature/*
  pull_request:
  release:
    types:
      - published
  workflow_dispatch:

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: true
      - name: Build
        run: |
          sudo apt-get update -y && sudo apt-get install -y wget unzip file git openjdk-17-jdk
          git submodule foreach git submodule update --init
          wget https://dl.google.com/android/repository/commandlinetools-linux-13114758_latest.zip
          mkdir sdk
          unzip -d sdk commandlinetools-linux-13114758_latest.zip
          export ANDROID_HOME=`pwd`/sdk
          export ANDROID_SDK_ROOT=`pwd`/sdk
          export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
          yes | sdk/cmdline-tools/bin/sdkmanager --sdk_root=`pwd`/sdk --licenses
          ./gradlew assembleRelease assembleDebug
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            ref_name="pr-${{ github.event.pull_request.number }}"
          else
            ref_name="${{ github.ref_name }}"
          fi
          # Replace / with - in ref_name for valid artifact name
          ref_name=$(echo "$ref_name" | tr '/' '-')
          echo "ref_name=${ref_name}" >> $GITHUB_ENV
          # Copy all ABI-specific APKs
          mkdir -p artifacts
          for apk in app/build/outputs/apk/release/*-release.apk; do
            if [ -f "$apk" ]; then
              cp "$apk" artifacts/
            fi
          done
          for apk in app/build/outputs/apk/debug/*-debug.apk; do
            if [ -f "$apk" ]; then
              cp "$apk" artifacts/
            fi
          done
      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: hev.sockstun-${{ env.ref_name }}-build
          path: artifacts/
          if-no-files-found: error
          retention-days: 1

  release-latest:
    name: Update Latest Release
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: release
          pattern: "hev.sockstun-*-build"
          merge-multiple: true
      - name: Update release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Determine release tag based on branch
          if [[ "${{ github.ref_name }}" == "main" ]]; then
            release_name="latest"
            release_title="Latest Build"
          else
            # Convert branch name to valid release tag
            release_tag=$(echo "${{ github.ref_name }}" | tr '/' '-')
            release_name="$release_tag"
            release_title="Build from $release_tag"
          fi

          # Delete old release if exists
          if gh release view "$release_name" >/dev/null 2>&1; then
            gh release delete "$release_name" --yes
          fi

          # Create or update release
          gh release create "$release_name" \
            --title "$release_title" \
            --notes "Automated build from ${{ github.ref_name }}. Commit: ${{ github.sha }}" \
            --prerelease

          # Upload new assets
          for i in release/hev.sockstun-*; do
            gh release upload "$release_name" $i
          done

  # release:
  #   name: Release
  #   runs-on: ubuntu-latest
  #   needs: build
  #   if: github.event_name == 'release'
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4
  #       with:
  #         fetch-depth: 1
  #     - name: Download artifacts
  #       uses: actions/download-artifact@v4
  #       with:
  #         path: release
  #         pattern: "hev.sockstun-*"
  #         merge-multiple: true
  #     - name: Upload artifacts
  #       env:
  #         GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  #       run: |
  #         for i in release/hev.sockstun-*; do
  #           gh release upload ${{ github.event.release.tag_name }} $i
  #         done
